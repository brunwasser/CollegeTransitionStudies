---
title: "Depression Trajectories"
author: "Steve Brunwasser"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: yes
    toc_depth: 2
    toc_float: yes
    number_sections: yes
    code_folding: hide
    theme: cosmo
    highlight: tango
---
```{r include=FALSE}
knitr::opts_chunk$set( warning = F, message = F )
```


# Workspace prep


Prepare the workspace.
```{r workspace}
load( 'G:/My Drive/PrevSciLab/Students/PhdStudents/NicoleK/TransitionStudy/ctsr.RData' )
load( 'pro.RData' )

require( Hmisc )
require( rms )
require( lme4 )
require( dagitty )
require( ggeffects )
require( DHARMa )
require( GLMMadaptive )

```

# Data Prep
```{r dataprep}
times.c1.a1 <- read.csv( 'ctsr.c1.a1.times.csv', header = T )
times.c2.a1 <- read.csv( 'ctsr.c2.a1.times.csv', header = T )
times.a1 <- rbind( times.c1.a1, times.c2.a1 )
which( duplicated( times.a1$id ) )

times.c1.a2 <- read.csv( 'ctsr.c1.a2.times.csv', header = T )
times.c2.a2 <- read.csv( 'ctsr.c2.a2.times.csv', header = T )
times.a2 <- rbind( times.c1.a2, times.c2.a2 )


times.c1.a3 <- read.csv( 'ctsr.c1.a3.times.csv', header = T )
times.c2.a3 <- read.csv( 'ctsr.c2.a3.times.csv', header = T )
times.a3 <- rbind( times.c1.a3, times.c2.a3 )

times.c1.a4 <- read.csv( 'ctsr.c1.a4.times.csv', header = T )
times.c2.a4 <- read.csv( 'ctsr.c2.a4.times.csv', header = T )
times.a4 <- rbind( times.c1.a4, times.c2.a4 )

times.c1.a5 <- read.csv( 'ctsr.c1.a5.times.csv', header = T )
times.c2.a5 <- read.csv( 'ctsr.c2.a5.times.csv', header = T )
times.a5 <- rbind( times.c1.a5, times.c2.a5 )


times <- rbind( times.a1, times.a2, times.a3, times.a4, times.a5 )
times[ times == -999 ] <- NA

times$start <- as.Date( times$starttime, format ="%d-%b-%y" )
times$end <- as.Date( times$finishtime, format ="%d-%b-%y" )

library(dplyr)

times2 <- times %>%
  group_by( id, assess ) %>%
  filter(start == max(start) )

times2 <- as.data.frame( times2 )
times2$assess <- factor( times2$assess )

ctsr1 <- subset( ctsr, !is.na( ctsr$transfer ), 
                 c( 'id','assess','week','campus','group','male','race2','parented','college','pastfin',
                    'curfin','relig','medsever','medscur','txcur','therever','thercur',
                    'txever','phq','bis','bas','transfer' )
                 )
ctsr1a <- merge( ctsr1, pro, by = 'id', all.x = T )

ctsr1b <- merge( ctsr1a, times2, by = c( 'id', 'assess' ) , all.x = T )

cohort <- read.csv( 'cohort.csv', header = T )

ctsr1c <- merge( ctsr1b, cohort, by = 'id' )


ids <- ctsr1b[ !duplicated( ctsr1b$id), 'id' ]
  
timeall <- data.frame( id = rep( ids, each = 5 ),
                       assess = rep( 1:5, length( ids ) ) 
                       )

ctsr.use <- merge( timeall, ctsr1c, by = c('id','assess'), all.x = T )

ctsr.use$cohort.f <- factor( ctsr.use$cohort,
                            levels = 1:2,
                            labels = c( '2010 Cohort','2011 Cohort' ) 
                            )

semesterStart2010 <- as.Date( '7-Sep-10', format = "%d-%b-%y" )
semesterStart2011 <- as.Date( '31-Aug-11', format = "%d-%b-%y" )

ctsr.use$days <- ifelse( ctsr.use$cohort.f == '2010 Cohort', 
                         ctsr.use$start - semesterStart2010,
                         ctsr.use$start - semesterStart2011 
                         )

label( ctsr.use$id ) <- 'Unique participant identifier'
label( ctsr.use$week ) <- 'Week of the semester (0=semester begins)'
label( ctsr.use$campus ) <- 'Does participant live on campus?'
label( ctsr.use$transfer ) <- 'Is the student a transfer?'
label( ctsr.use$group ) <- 'Transfer & campus housing status'
ctsr.use$sex <- factor( ctsr.use$male, levels = 0:1, labels = c('Female','Male') )
label( ctsr.use$male ) <- 'Participant self-reported sex'
label( ctsr.use$race2 ) <- 'Participant self-reported race'
label( ctsr.use$parented ) <- 'Level parent education'
ctsr.use$nocollege <- relevel( ctsr.use$college, ref = 'College Degree' )
label( ctsr.use$college ) <- 'Parent with a college degree?'
label( ctsr.use$pastfin ) <- 'Financial comfort growing up'
ctsr.use$curfinf <-  factor( ctsr.use$curfin, ordered = F )
ctsr.use$curfin <- relevel( ctsr.use$curfinf, ref = 'Tight but fine' )
label( ctsr.use$curfin ) <- 'Current financial comfort'
label( ctsr.use$relig ) <- 'Level of religiousness'
label( ctsr.use$medsever ) <- 'Ever taken medication for mental health?'
label( ctsr.use$medscur ) <- 'Currently take medication for mental health?'
label( ctsr.use$txcur ) <- 'Any current mental health treatment?'
label( ctsr.use$therever ) <- 'Ever had counseling or psychotherapy?'
label( ctsr.use$thercur ) <- 'Currently receive counseling or psychotherapy?'
ctsr.use$txever <- factor( ctsr.use$txever, levels = 0:1, labels = c( 'No','Yes' ) )
label( ctsr.use$txever ) <- 'Ever recive mental health treatment (medication or psychotherapy)?'
label( ctsr.use$phq ) <- 'PHQ-8 total depression score'
label( ctsr.use$procrast.t1 ) <- 'Procrastination Scale composite score'
label( ctsr.use$bis ) <- 'BIS/BAS: Behavioral inhibition composite'
label( ctsr.use$bas ) <- 'BIS/BAS: Behavioral activation composite'
label( ctsr.use$start ) <- 'Date Survey Started'
label( ctsr.use$start ) <- 'Date Survey Ended'

levels( ctsr.use$transfer ) <- c('First-Year','Transfer')

ctsr.use$bisct <- ctsr.use$bis - mean( ctsr$bis, na.rm = T )
ctsr.use$procrastct <- ctsr.use$procrast.t1 - mean( ctsr.use$procrast.t1, na.rm = T )

ctsr.use$campus[ ctsr.use$id == 29 ] <- 'Campus' ## participant wrote "on campus" in "other housing" explanation 
ctsr.use$campus[ ctsr.use$id == 53 ] <- 'Off Campus' ## participant wrote "living with family"
ctsr.use$campus[ ctsr.use$id == 60 ] <- 'Off Campus' ## participant wrote living off campus with family
ctsr.use$campus[ ctsr.use$id == 90 ] <- 'Campus' ## participant wrote "on campus apartment with roommates" in "other housing" explanation 
ctsr.use$campus[ ctsr.use$id == 216 ] <- 'Campus' ## participant wrote living in campus organization house "other housing" explanation 
ctsr.use$campus[ ctsr.use$id == 295 ] <- 'Off Campus' ## participant wrote "off campus with husband" in "other housing" explanation 
ctsr.use$campus[ ctsr.use$id == 369 ] <- 'Off Campus' ## participant wrote off campus in "other housing" explanation 
ctsr.use$campus[ ctsr.use$id == 370 ] <- 'Off Campus' ## participant wrote "off campus with husband" in "other housing" explanation 

ctsr.use$parented[ ctsr.use$id == 38 ] <- "Post-college degree" ## DVM
ctsr.use$parented[ ctsr.use$id == 47 ] <- "Some college" ## Technical school
ctsr.use$parented[ ctsr.use$id == 235 ] <- "Post-college degree" ##  Postdoc
ctsr.use$parented[ ctsr.use$id == 255 ] <- "College degree" ## Associated degree

ctsr.use$college[ ctsr.use$id == 38 ] <- "College Degree" ## DVM
ctsr.use$college[ ctsr.use$id == 47 ] <- "No College Degree" ## Technical school
ctsr.use$college[ ctsr.use$id == 235 ] <- "College Degree" ##  Postdoc
ctsr.use$college[ ctsr.use$id == 255 ] <- "College Degree" ## Associated degree

ctsr.use$race2[ ctsr.use$id == 34 ] <- 'Other' # Multiracial
ctsr.use$race2[ ctsr.use$id == 101 ] <- 'Other' # Multiracial
ctsr.use$race2[ ctsr.use$id == 231 ] <- 'Other' # Multiracial
ctsr.use$race2[ ctsr.use$id == 268 ] <- 'Other' # Multiracial
ctsr.use$race2[ ctsr.use$id == 291 ] <- 'Other' # Multiracial

ctsr.use$transfer.campus <- NULL
ctsr.use$transfer.campus[ ctsr.use$transfer == 'First-Year' ] <- 1
ctsr.use$transfer.campus[ ctsr.use$transfer == 'Transfer' & ctsr.use$campus == 'Campus' ] <- 2
ctsr.use$transfer.campus[ ctsr.use$transfer == 'Transfer' & ctsr.use$campus == 'Off Campus' ] <- 3
ctsr.use$transfer.campus.f <- factor( ctsr.use$transfer.campus, levels = 1:3, labels = c('First-Year','Transfer: On Campus','Transfer: Off Campus' ) )
label( ctsr.use$transfer.campus.f ) <- 'Student Type' 

ctsr.use$weeks <- ctsr.use$days/7
label( ctsr.use$weeks ) <- 'Week of the semester'

html( describe( ctsr.use ) )

dd <- datadist( ctsr.use )
options( datadist = 'dd' )

```


# Directed Acyclic Graph (DAG)
```{r dag}
dag <- dagitty('dag {
"Adverse life events" [pos="-1.838,-0.653"]
"Current mental health problems" [pos="-0.306,0.955"]
"Finances current" [pos="-1.364,-0.070"]
"Finances past" [pos="0.026,0.057"]
"Parent education" [pos="-0.192,-0.969"]
"Past mental health problems" [pos="0.877,-0.871"]
Depression [outcome,pos="1.182,1.293"]
Genetics [pos="-1.099,-1.831"]
Group [exposure,pos="-1.798,1.286"]
Inhibition [pos="-1.652,-1.393"]
Procrastination [pos="1.142,-0.289"]
Race [pos="-0.034,-1.885"]
Sex [pos="0.440,-1.721"]
"Adverse life events" -> "Current mental health problems" [pos="-1.301,0.676"]
"Adverse life events" -> "Finances current" [pos="-1.631,-0.413"]
"Adverse life events" -> "Finances past"
"Adverse life events" -> "Past mental health problems"
"Adverse life events" -> Depression
"Adverse life events" -> Group
"Adverse life events" -> Procrastination
"Current mental health problems" -> Depression
"Current mental health problems" -> Group
"Current mental health problems" <-> Procrastination
"Finances current" -> "Current mental health problems"
"Finances current" -> Depression
"Finances current" -> Group
"Finances past" -> "Finances current"
"Finances past" -> "Past mental health problems"
"Parent education" -> "Finances current"
"Parent education" -> "Finances past"
"Parent education" -> Depression
"Past mental health problems" -> "Current mental health problems"
"Past mental health problems" -> Depression [pos="1.014,0.657"]
"Past mental health problems" <-> Procrastination
Genetics -> "Adverse life events"
Genetics -> "Current mental health problems"
Genetics -> "Parent education"
Genetics -> "Past mental health problems"
Genetics -> Depression [pos="-0.253,-0.647"]
Genetics -> Group
Genetics -> Inhibition
Genetics -> Procrastination
Group -> Depression
Inhibition -> "Adverse life events"
Inhibition -> "Current mental health problems"
Inhibition -> "Past mental health problems"
Inhibition -> Depression [pos="-0.597,0.257"]
Inhibition -> Group
Inhibition -> Procrastination [pos="0.096,-0.101"]
Procrastination -> Depression
Procrastination -> Group
Race -> "Adverse life events"
Race -> "Finances current"
Race -> "Finances past"
Race -> "Parent education"
Race -> Depression
Race -> Group
Sex -> "Adverse life events"
Sex -> "Current mental health problems" [pos="-0.025,-0.720"]
Sex -> "Past mental health problems"
Sex -> Depression
Sex -> Group [pos="0.244,-1.199"]
Sex -> Inhibition
}
')

plot( dag )

```

View the DAG's causal implications.
```{r dagimplications}
impliedConditionalIndependencies( dag )
```

View the minimally sufficient adjustment set implied by the DAG.
```{r}
adjustmentSets( dag )
```


# Statistical Modeling

Redundancy analysis to evaluate the extent of multicollinearity 
```{r}

redun( phq ~ transfer.campus.f + txcur + curfin + procrastct + bisct + race2 + male + cohort.f + days, data = ctsr.use )
```

## m0: Unconditional model
This mixed-effects negative binomial model evaluates the effect of student group (0=first-year; 1=transfer on campus; 2=transfer off campus) on depressive symptoms at the start of the semester (weeks = 0) and on the rate of change in symptoms across the semester without any covariate adjustment. 
```{r}

# m0 <- glmer.nb( phq ~ transfer.campus.f*rcs( weeks, 3, c(2, 6, 11) ) 
#                 + ( 1 | id ),
#                 data = ctsr.use,
#                 verbose = T
#                 )
# 
# save( m0, file = 'm0.Rdata' )
load( 'm0.Rdata' )
summary( m0 )
```




## m1: Most complex model
```{r}

m1 <- glmer.nb( phq ~ transfer.campus.f*rcs( weeks, 3, c(2, 6, 11) ) 
                + txcur*rcs(  weeks, 3, c(2, 6, 11) ) 
                + rcs( procrastct, 3)*rcs(  weeks, 3, c(2, 6, 11) ) 
                + rcs( bisct, 3)*rcs(  weeks, 3, c(2, 6, 11) )
                + curfin  
                + race2 
                + male 
                + cohort.f
                + ( 1 | id ),
                data = ctsr.use,
                verbose = T
                )

save( m1, file = 'm1.Rdata' )
load( 'm1.Rdata' )
```


Drop rcs for BIS
```{r}

m2 <- glmer.nb( phq ~ transfer.campus.f*rcs( weeks, 3, c(2, 6, 11) ) 
                + txcur*rcs(  weeks, 3, c(2, 6, 11) ) 
                + rcs( procrastct, 3)*rcs(  weeks, 3, c(2, 6, 11) ) 
                + bisct*rcs(  weeks, 3, c(2, 6, 11) )
                + curfin  
                + race2 
                + male 
                + cohort.f
                + ( 1 | id ),
                data = ctsr.use,
                verbose = T
                )

save( m2, file = 'm2.Rdata' )
load( 'm2.Rdata' )
```

Likelihood ratio test: Get rid of rcs for BIS
```{r}
( lrt1.m1.m2 <- anova( m1, m2 ) )

save( lrt1.m1.m2, file = 'lrt1.m1.m2.RData' )
load( 'lrt1.m1.m2.RData' )
```

Drop rcs for procrastination

```{r}

m3 <- glmer.nb( phq ~ transfer.campus.f*rcs( weeks, 3, c(2, 6, 11) ) 
                + txcur*rcs(  weeks, 3, c(2, 6, 11) ) 
                + procrastct*rcs(  weeks, 3, c(2, 6, 11) ) 
                + bisct*rcs(  weeks, 3, c(2, 6, 11) )
                + curfin  
                + race2 
                + male 
                + cohort.f
                + ( 1 | id ),
                data = ctsr.use,
                verbose = T
                )

save( m3, file = 'm3.Rdata' )
load( 'm3.Rdata' )
```



Likelihood ratio test: Get rid of rcs for BIS
```{r}
( lrt1.m2.m3 <- anova( m2, m3 ) )

save( lrt1.m2.m3, file = 'lrt1.m2.m3.RData' )
load( 'lrt1.m2.m3.RData' )
```


Drop rcs for weeks

```{r}

m4 <- glmer.nb( phq ~ transfer.campus.f*weeks 
                + txcur*weeks
                + procrastct*weeks 
                + bisct*weeks 
                + curfin  
                + race2 
                + sex 
                + cohort.f
                + ( 1 | id ),
                data = ctsr.use,
                verbose = T
                )

save( m4, file = 'm4.Rdata' )
load( 'm4.Rdata' )
```


```{r}

m5 <- glmer.nb( phq ~ weeks 
                + txcur*weeks
                + procrastct*weeks 
                + bisct*weeks 
                + curfin  
                + race2 
                + sex 
                + cohort.f
                + ( 1 | id ),
                data = ctsr.use,
                verbose = T
                )

save( m5, file = 'm5.Rdata' )
load( 'm5.Rdata' )
```

```{r}
anova( m4, m5 )
```

```{r}

m6 <- glmer.nb( phq ~ weeks 
                + transfer.campus.f
                + txcur*weeks
                + procrastct*weeks 
                + bisct*weeks 
                + curfin  
                + race2 
                + sex 
                + cohort.f
                + ( 1 | id ),
                data = ctsr.use,
                verbose = T
                )

save( m6, file = 'm6.Rdata' )
load( 'm6.Rdata' )
```



```{r}

m5 <- glmer( phq ~ transfer.campus.f*weeks 
                + txcur*weeks
                + procrastct*weeks 
                + bisct*weeks 
                + curfin  
                + race2 
                + male 
                + cohort.f
                + ( 1 | id ),
             family = poisson,
                data = ctsr.use,
                verbose = T
                )

save( m5, file = 'm5.Rdata' )
load( 'm5.Rdata' )
```



```{r}

m4.ressim <- simulateResiduals( fittedModel = m4, plot = F)
plot( m4.ressim )
testOutliers( m4 )

m4.ressim.grp <- recalculateResiduals( m4.ressim, group = ctsr.use$transfer.campus.f )

m5.ressim <- simulateResiduals( fittedModel = m5, plot = F)
plot( m5.ressim )

testDispersion( m4.ressim )

```

```{r}

m4aq <- glmer.nb( phq ~ transfer.campus.f*weeks 
                + txcur*weeks
                + procrastct*weeks 
                + bisct*weeks 
                + curfin  
                + race2 
                + sex 
                + cohort.f
                + ( 1 | id ),
                nAGQ = 5,
                data = ctsr.use,
                verbose = T
                )

save( m4aq, file = 'm4aq.Rdata' )
load( 'm4aq.Rdata' )
```


m4 Prediction plot
```{r}
m4predplot <- ggpredict( m4, term=c('weeks','transfer.campus.f')) 

cbbPalette <- c("#000000", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7")
plot( m4predplot, color = cbbPalette )

ggplot( m4predplot, aes(x, predicted, colour = group)) + 
  geom_line() +
  labs(
    x = get_x_title( m4predplot ),
    y = get_y_title( m4predplot ),
    colour = get_legend_title( m4predplot )
  )
```


```{r}
strict_tol <- glmerControl(optCtrl=list(xtol_abs=1e-8, ftol_abs=1e-8))

ctsr.use.scale <- transform( ctsr.use, bisct=scale(bisct))

m4.tol <- update( m4, control=strict_tol )

m4.scale <- update( m4, data=ctsr.use.scale )
```

```{r}
devfun <- update( m4, devFunOnly=TRUE)
if (isLMM(m4)) {
    pars <- getME(m4,"theta")
} else {
    ## GLMM: requires both random and fixed parameters
    pars <- getME(m4, c("theta","fixef"))
}
if (require("numDeriv")) {
    cat("hess:\n"); print(hess <- hessian(devfun, unlist(pars)))
    cat("grad:\n"); print(grad <- grad(devfun, unlist(pars)))
    cat("scaled gradient:\n")
    print(scgrad <- solve(chol(hess), grad))
}
## compare with internal calculations:
m4@optinfo$derivs
```

```{r}
## 4. restart the fit from the original value (or
## a slightly perturbed value):
m4.restart <- update( m4, start=pars)
set.seed(101)
pars_x <- runif(length(pars),pars/1.01,pars*1.01)
m4.restart2 <- update(m4, start=pars_x,
                       control=strict_tol)
```

```{r}
m4.all <- allFit(m4)
ss <- summary(m4.all)

  ss$ fixef               ## fixed effects
  ss$ llik                ## log-likelihoods
  ss$ sdcor               ## SDs and correlations
  ss$ theta               ## Cholesky factors
  ss$ which.OK            ## which fits worked

theta <- getME(m4,"theta")
## diagonal elements are identifiable because they are fitted
##  with a lower bound of zero ...
diag.element <- getME(m4,"lower")==0
any(theta[diag.element]<1e-5)
```

```{r}
html( describe( ctsr.use ) )
```



### m0.symp: Complex poisson model
```{r}
m0.symp <- mixed_model( fixed = phq ~ transfer.campus.f*rcs( weeks, 3 ) 
                + txcur*rcs(  weeks, 3 ) 
                + rcs( procrastct, 3)*rcs(  weeks, 3 )  
                + rcs( bisct, 3)*rcs(  weeks, 3 )
                + curfin  
                + race2 
                + male 
                + cohort.f,
                random =~ rcs( weeks, 3 ) | id,
                data = ctsr.use,
                family = poisson()
                )

save( m0.symp, file = 'm0.symp.Rdata' )
load( 'm0.symp.Rdata' )
```


### m1.symp: Complex negative binomial model

* Adds $df=1$ to *m0.symp* in the form of a $\theta$ parameter to capture overdispersion

```{r}

m1.symp <- mixed_model( fixed = phq ~ transfer.campus.f*rcs( weeks, 3 ) 
                + txcur*rcs(  weeks, 3 ) 
                + rcs( procrastct, 3)*rcs(  weeks, 3 )  
                + rcs( bisct, 3)*rcs(  weeks, 3 )
                + curfin  
                + race2 
                + male 
                + cohort.f,
                random =~ rcs( weeks, 3 ) | id,
                data = ctsr.use,
                family = GLMMadaptive:::negative.binomial()
                )

save( m1.symp, file = 'm1.symp.Rdata' )
load( 'm1.symp.Rdata' )
```

#### COmpare 
```{r}
( lrt.m0symp.m1symp <- anova( m0.symp, m1.symp ) )
```



### m2.symp: 

* Drop the random coefficients for the nonlinear time 
* Allow random variation around the linear time effect
* 
```{r}

m2.symp <- mixed_model( fixed = phq ~ transfer.campus.f*rcs( weeks, 3 ) 
                + txcur*rcs( weeks, 3 ) 
                + rcs( procrastct, 3)*rcs( weeks, 3 )  
                + rcs( bisct, 3)*rcs( weeks, 3 ) 
                + curfin  
                + race2 
                + male 
                + cohort.f,
                random =~ weeks | id,
                data = ctsr.use,
                family = GLMMadaptive:::negative.binomial()
                )

save( m2.symp, file = 'm2.symp.Rdata' )
load( 'm2.symp.Rdata' )
```



```{r}
anova( m1.symp, m2.symp )
```


### m3.symp: Drop random effects for linear time effect

* Results in gain of $df=2$ as random coefficient & correlation between random intercepts & slopes is dropped

```{r}

m3.symp <- mixed_model( fixed = phq ~ transfer.campus.f*rcs( weeks, 3 ) 
                + txcur*rcs( weeks, 3 )
                + rcs( procrastct, 3)*rcs( weeks, 3 )
                + rcs( bisct, 3)*rcs( weeks, 3 )
                + curfin  
                + race2 
                + male 
                + cohort.f,
                random =~ 1 | id,
                data = ctsr.use,
                family = GLMMadaptive:::negative.binomial()
                )

save( m3.symp, file = 'm3.symp.Rdata' )
load( 'm3.symp.Rdata' )
```


```{r}
anova( m2.symp, m3.symp )
```



Make the effect of procrastination linear.

```{r}

m4.symp <- mixed_model( fixed = phq ~ transfer.campus.f*rcs( weeks, 3 )
                + txcur*rcs( weeks, 3 )
                + procrastct*rcs( weeks, 3 )
                + rcs( bisct, 3)*rcs( weeks, 3 )
                + curfin  
                + race2 
                + male 
                + cohort.f,
                random =~ weeks | id,
                data = ctsr.use,
                family = GLMMadaptive:::negative.binomial()
                )

save( m4.symp, file = 'm4.symp.Rdata' )
load( 'm4.symp.Rdata' )
```


```{r}
anova( m2.symp, m4.symp )
```


```{r}

m5.symp <- mixed_model( fixed = phq ~ transfer.campus.f*rcs( weeks, 3 )
                + txcur*rcs( weeks, 3 )
                + procrastct*rcs( weeks, 3 )
                + bisct*rcs( weeks, 3 )
                + curfin  
                + race2 
                + male 
                + cohort.f,
                random =~ weeks | id,
                data = ctsr.use,
                family = GLMMadaptive:::negative.binomial()
                )

save( m5.symp, file = 'm5.symp.Rdata' )
load( 'm5.symp.Rdata' )
```


```{r}
anova( m4.symp, m5.symp )
```



```{r}

m6.symp <- mixed_model( fixed = phq ~ transfer.campus.f*weeks
                + txcur*weeks
                + procrastct*weeks 
                + bisct*weeks
                + curfin  
                + race2 
                + male 
                + cohort.f,
                random =~ weeks | id,
                data = ctsr.use,
                family = GLMMadaptive:::negative.binomial()
                )

save( m6.symp, file = 'm6.symp.Rdata' )
load( 'm6.symp.Rdata' )
```




```{r}
anova( m5.symp, m6.symp )
```


```{r}

m7.symp <- mixed_model( fixed = phq ~ weeks
                + txcur*weeks
                + procrastct*weeks 
                + bisct*weeks
                + curfin  
                + race2 
                + male 
                + cohort.f,
                random =~ weeks | id,
                data = ctsr.use,
                family = GLMMadaptive:::negative.binomial()
                )

save( m7.symp, file = 'm7.symp.Rdata' )
load( 'm7.symp.Rdata' )
```




```{r}
anova( m6.symp, m7.symp )
```


```{r}

m8.symp <- mixed_model( fixed = phq ~ transfer.campus.f + weeks
                + txcur*weeks
                + procrastct*weeks 
                + bisct*weeks
                + curfin  
                + race2 
                + male 
                + cohort.f,
                random =~ weeks | id,
                data = ctsr.use,
                family = GLMMadaptive:::negative.binomial()
                )

save( m8.symp, file = 'm8.symp.Rdata' )
load( 'm8.symp.Rdata' )
```




```{r}
anova( m6.symp, m8.symp )
```


```{r}
m6.symp.predplot <- ggpredict( m6.symp, term=c('weeks','transfer.campus.f') ) 

cbbPalette <- c("#000000", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7")
plot( m6.symp.predplot, color = cbbPalette )

ggplot( m6predplot, aes(x, predicted, colour = group)) + 
  geom_line() +
  labs(
    x = get_x_title( m6predplot ),
    y = get_y_title( m6predplot ),
    colour = get_legend_title( m6predplot )
  )
```





```{r}


m4.symp1 <- mixed_model(fixed = phq ~ transfer.campus.f*weeks 
                + txcur*weeks
                + procrastct*weeks 
                + bisct*weeks 
                + curfin  
                + race2 
                + sex 
                + cohort.f, 
                random = ~ 1 | id, 
                data = ctsr.use,
                family = negative.binomial()
                )

m4.symp1.ressim <- simulateResiduals( fittedModel = m4.symp1, plot = F)
```


```{r}
m4.symp2 <- mixed_model(fixed = phq ~ transfer.campus.f*weeks 
                + txcur*weeks
                + procrastct*weeks 
                + bisct*weeks 
                + curfin  
                + race2 
                + sex 
                + cohort.f, 
                random = ~ weeks | id, 
                data = ctsr.use,
                family = negative.binomial())

m4.symp2.ressim <- simulateResiduals( fittedModel = m4.symp2, plot = F )
```


```{r}
m4.symp2.predplot <- ggpredict( m4.symp2, term=c('weeks','transfer.campus.f')) 

cbbPalette <- c("#000000", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7")
plot( m4.symp2.predplot, color = cbbPalette )

ggplot( m4predplot, aes(x, predicted, colour = group)) + 
  geom_line() +
  labs(
    x = get_x_title( m4predplot ),
    y = get_y_title( m4predplot ),
    colour = get_legend_title( m4predplot )
  )
```

