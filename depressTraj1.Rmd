---
title: "Depression Trajectories"
author: "Steve Brunwasser"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: yes
    toc_depth: 4
    toc_float: yes
    number_sections: yes
    code_folding: hide
    theme: cosmo
    highlight: tango
---
```{r settings, include=FALSE}
knitr::opts_chunk$set( warning = F, message = F )
```


# Workspace prep


Prepare the workspace.
```{r workspace}
load( 'ctsr.use.RData' )
load( 'cts.RData' )

require( Hmisc )
require( rms )
require( lme4 )
require( dagitty )
require( ggeffects )
require( DHARMa )
require( GLMMadaptive )
require( table1 )
require( piecewiseSEM )
require( MASS )
require( car )

```

# Study 1: College Transition Study (CTS)


## Data Prep

Create a data frame containing the subset of variables to be use in the analysis and make categorical variables factors.
```{r}
cts.use <- cts[, c('id','assess','transfer','sex','race','age','int','parenteduc','trans.commun','campus','group','week','cesdtot')]
cts.use$minority <- factor( ifelse( cts.use$race == 'White/Caucasian', 0, 1 ),
                         levels = 0:1,
                         labels = c('Non-Hispanic White/Caucasian','Minority Race/Ethnicity') 
                         )


cts.use$nocollege <- factor( ifelse( cts.use$parenteduc == 'College degree' | cts.use$parenteduc == 'Post-college degree', 0, 1 ),
                         levels = 0:1,
                         labels = c('College ','No college') )


levels( cts.use$transfer ) <- c('First Years','Transfers')
levels( cts.use$group ) <- c('First Year','Transfer: On Campus','Transfer: Off Campus')
```


## Modeling Symptom Trajectories

Conduct a redundancy analysis to assess for high levels of collinearity in the model predictors.
```{r}
cts.use1 <- subset( cts.use, assess == 1 )

redun( cesdtot ~ transfer + sex + minority + nocollege + int, data = cts.use1  )
```

```{r}
# m0.cts <- mixed_model( fixed = cesdtot ~ transfer*rcs( week, 3 )
#                 + sex*rcs( week, 3 ) 
#                 + minority*rcs( week, 3 ) 
#                 + nocollege*rcs( week, 3 ) 
#                 + int*rcs( week, 3 ),
#                 random =~ week | id,
#                 data = cts.use,
#                 family = poisson()
#                 )
# 
# save( m0.cts, file = 'm0.cts.Rdata' )

load( 'm0.cts.Rdata' )
```


```{r}
# m1.cts <- mixed_model( fixed = cesdtot ~ transfer*rcs( week, 3 )
#                 + sex*rcs( week, 3 ) 
#                 + minority*rcs( week, 3 ) 
#                 + nocollege*rcs( week, 3 ) 
#                 + int*rcs( week, 3 ),
#                 random =~ week | id,
#                 data = cts.use,
#                 family = GLMMadaptive:::negative.binomial()
#                 )
# 
# save( m1.cts, file = 'm1.cts.Rdata' )

load( 'm1.cts.Rdata' )
```



```{r}
anova( m0.cts, m1.cts )
```

```{r}
# m2.cts <- mixed_model( fixed = cesdtot ~ transfer*rcs( week, 3 )
#                 + sex*rcs( week, 3 ) 
#                 + minority*rcs( week, 3 ) 
#                 + nocollege*rcs( week, 3 ) 
#                 + int*rcs( week, 3 ),
#                 random =~ 1 | id,
#                 data = cts.use,
#                 family = GLMMadaptive:::negative.binomial()
#                 )
# 
# save( m2.cts, file = 'm2.cts.Rdata' )

load( 'm2.cts.Rdata' )
```



```{r}
anova( m1.cts, m2.cts )
```

Remove sex by time interaction
```{r}
# m3.cts <- mixed_model( fixed = cesdtot ~ transfer*rcs( week, 3 )
#                 + sex
#                 + minority*rcs( week, 3 )
#                 + nocollege*rcs( week, 3 )
#                 + int*rcs( week, 3 ),
#                 random =~ week | id,
#                 data = cts.use,
#                 family = GLMMadaptive:::negative.binomial()
#                 )
# 
# save( m3.cts, file = 'm3.cts.Rdata' )

load( 'm3.cts.Rdata' )
```


```{r}
anova( m1.cts, m3.cts )
```

Remove minority race/ethnicity by time interaction
```{r}
# m4.cts <- mixed_model( fixed = cesdtot ~ transfer*rcs( week, 3 )
#                 + sex*rcs( week, 3 ) 
#                 + minority
#                 + nocollege*rcs( week, 3 ) 
#                 + int*rcs( week, 3 ),
#                 random =~ week | id,
#                 data = cts.use,
#                 family = GLMMadaptive:::negative.binomial()
#                 )
# 
# save( m4.cts, file = 'm4.cts.Rdata' )

load( 'm4.cts.Rdata' )
```


```{r}
anova( m1.cts, m4.cts )
```

Remove parent education by time interaction
```{r}
# m5.cts <- mixed_model( fixed = cesdtot ~ transfer*rcs( week, 3 )
#                 + sex*rcs( week, 3 ) 
#                 + minority
#                 + nocollege
#                 + int*rcs( week, 3 ),
#                 random =~ week | id,
#                 data = cts.use,
#                 family = GLMMadaptive:::negative.binomial()
#                 )
# 
# save( m5.cts, file = 'm5.cts.Rdata' )

load( 'm5.cts.Rdata' )
```


```{r}
anova( m4.cts, m5.cts )
```


Remove international student status by time interaction
```{r}
# m6.cts <- mixed_model( fixed = cesdtot ~ transfer*rcs( week, 3 )
#                 + sex*rcs( week, 3 ) 
#                 + minority
#                 + nocollege
#                 + int,
#                 random =~ week | id,
#                 data = cts.use,
#                 family = GLMMadaptive:::negative.binomial()
#                 )
# 
# save( m6.cts, file = 'm6.cts.Rdata' )

load( 'm6.cts.Rdata' )
```


```{r}
anova( m5.cts, m6.cts )
```

Drop nonlinear fixed time effects
```{r}
# m7.cts <- mixed_model( fixed = cesdtot ~ transfer*week
#                 + sex*week
#                 + minority
#                 + nocollege
#                 + int*week,
#                 random =~ week | id,
#                 data = cts.use,
#                 family = GLMMadaptive:::negative.binomial()
#                 )
# 
# save( m7.cts, file = 'm7.cts.Rdata' )

load( 'm7.cts.Rdata' )


```


```{r}
anova( m5.cts, m7.cts )
```

```{r}
# m8.cts <- mixed_model( fixed = cesdtot ~ transfer + week
#                 + sex*week
#                 + minority
#                 + nocollege
#                 + int*week,
#                 random =~ week | id,
#                 data = cts.use,
#                 family = GLMMadaptive:::negative.binomial()
#                 )
# 
# save( m8.cts, file = 'm8.cts.Rdata' )

load( 'm8.cts.Rdata' )
```


```{r}
anova( m7.cts, m8.cts)
```


```{r}
# m9.cts <- mixed_model( fixed = cesdtot ~ week
#                 + sex*week
#                 + minority
#                 + nocollege
#                 + int*week,
#                 random =~ week | id,
#                 data = cts.use,
#                 family = GLMMadaptive:::negative.binomial()
#                 )
# 
# save( m9.cts, file = 'm9.cts.Rdata' )

load( 'm9.cts.Rdata' )
```


```{r}
anova( m7.cts, m9.cts )

```





```{r}
# m10.cts <- mixed_model( fixed = cesdtot ~ group*week
#                 + sex*week
#                 + minority
#                 + nocollege
#                 + int*week,
#                 random =~ week | id,
#                 data = cts.use,
#                 family = GLMMadaptive:::negative.binomial()
#                 )
# 
# save( m10.cts, file = 'm10.cts.Rdata' )

load( 'm10.cts.Rdata' )
```


```{r}

cts.use.nm <- cts.use[ !is.na( cts.use$cesdtot ), ]



summarySE <- function(data=NULL, measurevar, groupvars=NULL, na.rm=FALSE,
                      conf.interval=.95, .drop=TRUE) {
    library(plyr)

    # New version of length which can handle NA's: if na.rm==T, don't count them
    length2 <- function (x, na.rm=FALSE) {
        if (na.rm) sum(!is.na(x))
        else       length(x)
    }

    # This does the summary. For each group's data frame, return a vector with
    # N, mean, and sd
    datac <- ddply(data, groupvars, .drop=.drop,
      .fun = function(xx, col) {
        c(N    = length2(xx[[col]], na.rm=na.rm),
          mean = mean   (xx[[col]], na.rm=na.rm),
          sd   = sd     (xx[[col]], na.rm=na.rm)
        )
      },
      measurevar
    )

    # Rename the "mean" column    
    datac <- rename(datac, c("mean" = measurevar))

    datac$se <- datac$sd / sqrt(datac$N)  # Calculate standard error of the mean

    # Confidence interval multiplier for standard error
    # Calculate t-statistic for confidence interval: 
    # e.g., if conf.interval is .95, use .975 (above/below), and use df=N-1
    ciMult <- qt(conf.interval/2 + .5, datac$N-1)
    datac$ci <- datac$se * ciMult

    return(datac)
}


traj <- summarySE( cts.use.nm, measurevar="cesdtot", groupvars=c("week","group"))

pd <- position_dodge(0.75) # move them .05 to the left and right

cbbPalette <- c("#000000", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7")

ggplot(traj, aes(x=week, y=cesdtot, colour=group, shape =group)) + 
    geom_errorbar(aes(ymin=cesdtot-ci, ymax=cesdtot+ci), width=.75, position=pd) +
    geom_line(position=pd) +
    geom_point(position=pd, size =3 ) +
  labs( title = 'Mean Depressive Symptom Trajectories',
       y = 'CES-D Total Score',
       subtitle = 'Observed Means & 95% Confidence Intervals' ) +
  scale_color_manual( values = cbbPalette ) +
  scale_x_continuous( 'Week of the Academic Semester', breaks = ( c(2,4,6,8,10,12,14,15))  ) +
  guides(col=guide_legend("Student Status"),
         shape=guide_legend("Student Status")) +
  theme( plot.title = element_text( size = 18, face = 'bold', color = 'darkblue', hjust = 0.5 ),
         plot.subtitle = element_text( size = 14, face = 'bold', hjust = 0.5 ),
         axis.title = element_text( size = 12 ) )


```

```{r}


m7.cts.pred <- ggpredict( m7.cts, term=c('week','transfer'), type = 'fe' )
save( m7.cts.pred, file = 'm7.cts.pred.RData'  )

m7.cts.pred1 <- ggpredict( m7.cts, term=c('week','sex'), type = 'fe' )
save( m7.cts.pred1, file = 'm7.cts.pred1.RData'  )

m10.cts.pred <- ggpredict( m10.cts, term=c('week','group'), type = 'fe' )
save( m10.cts.pred, file = 'm10.cts.pred.RData'  )
```


# Study 2: College Transition Study--Replication (CTSR)

## Directed Acyclic Graph (DAG)
```{r dag}
dag <- dagitty('dag {
"Baseline Mental Health Tx" [pos="-0.448,1.131"]
"Financial Comfort" [pos="0.625,0.041"]
"Inhibited Temperament" [pos="-0.408,-1.581"]
"Parent Education" [pos="0.254,-1.438"]
"Past Mental Health Problems" [pos="-0.425,-0.368"]
"Procrastination Tendency" [pos="-1.829,-0.647"]
"Race/Ethnicity" [pos="1.361,-1.587"]
"Student Status" [exposure,pos="-2.127,1.611"]
Depression [outcome,pos="1.400,1.621"]
Sex [pos="-2.211,-1.594"]
"Baseline Mental Health Tx" -> "Student Status"
"Baseline Mental Health Tx" -> Depression
"Financial Comfort" -> "Baseline Mental Health Tx"
"Financial Comfort" -> "Student Status"
"Financial Comfort" -> Depression
"Inhibited Temperament" -> "Baseline Mental Health Tx" [pos="0.046,-1.049"]
"Inhibited Temperament" -> "Past Mental Health Problems" [pos="-0.420,-1.244"]
"Inhibited Temperament" -> "Procrastination Tendency"
"Inhibited Temperament" -> "Student Status"
"Inhibited Temperament" -> Depression [pos="1.080,0.015"]
"Parent Education" -> "Baseline Mental Health Tx"
"Parent Education" -> "Financial Comfort"
"Parent Education" -> "Past Mental Health Problems"
"Parent Education" -> "Student Status"
"Parent Education" -> Depression [pos="1.170,-0.050"]
"Past Mental Health Problems" -> "Baseline Mental Health Tx" [pos="-0.425,0.041"]
"Past Mental Health Problems" -> "Student Status"
"Past Mental Health Problems" -> Depression
"Procrastination Tendency" -> "Baseline Mental Health Tx"
"Procrastination Tendency" -> "Past Mental Health Problems"
"Procrastination Tendency" -> "Student Status"
"Procrastination Tendency" -> Depression [pos="0.148,0.910"]
"Race/Ethnicity" -> "Baseline Mental Health Tx"
"Race/Ethnicity" -> "Financial Comfort"
"Race/Ethnicity" -> "Inhibited Temperament"
"Race/Ethnicity" -> "Parent Education"
"Race/Ethnicity" -> "Past Mental Health Problems"
"Race/Ethnicity" -> "Student Status"
"Race/Ethnicity" -> Depression
"Student Status" -> Depression
Sex -> "Baseline Mental Health Tx"
Sex -> "Inhibited Temperament"
Sex -> "Past Mental Health Problems"
Sex -> Depression
}
')

plot( dag )

```

View the DAG's causal implications.
```{r dagimplications}
impliedConditionalIndependencies( dag )
```


Evaluate whether there is evidence against causal implications of dag1
```{r}
ctsr.use.a1 <- subset( ctsr.use, assess == 1 )
ctsr.use.a1$curfin.o <- ordered( ctsr.use.a1$curfin )

imp1 <- polr( curfin.o ~ rcs( bisct, 3) + race2,
              Hess = T,
              data = ctsr.use.a1
              )
Anova( imp1 )

imp2 <- polr( curfin.o ~ mhpast + race2,
              Hess = T,
              data = ctsr.use.a1
              )
Anova( imp2 )

imp3 <- polr( curfin.o ~ rcs( procrastct, 3 ) + rcs( bisct, 3 ),
              Hess = T,
              data = ctsr.use.a1
              )

Anova( imp3 )

imp4 <- polr( curfin.o ~ rcs( procrastct, 3 ) + race2,
              Hess = T,
              data = ctsr.use.a1
              )
Anova( imp4 )

imp5 <- polr( curfin.o ~ sex,
              Hess = T,
              data = ctsr.use.a1
              )
Anova( imp5 )


imp6 <- lm( bisct ~ nocollege + race2,
              data = ctsr.use.a1
              )
Anova( imp6 )


imp7 <- glm( nocollege ~ rcs( procrastct, 3 ) + rcs( bisct, 3 ),
              data = ctsr.use.a1,
             family = binomial('logit')
              )
Anova( imp7 )


imp8 <- glm( nocollege ~ rcs( procrastct, 3 ) + race2,
              data = ctsr.use.a1,
             family = binomial('logit')
              )
Anova( imp8 )


imp8 <- glm( nocollege ~ sex,
              data = ctsr.use.a1,
             family = binomial('logit')
              )
Anova( imp8 )


imp9 <- lm( procrastct ~ race2 + rcs( bisct, 3 ),
              data = ctsr.use.a1
              )
Anova( imp9 )


imp10 <- lm( procrastct ~ sex + rcs( bisct, 3 ),
              data = ctsr.use.a1
              )
Anova( imp10 )

imp11 <- glm( sex ~ race2,
              data = ctsr.use.a1,
             family = binomial('logit')
              )
Anova( imp11 )

```

Revise dag1 based on evidence against conditional independence assumptions 

* Include direct effect of sex on procrastination
* Include unobserved confounder driving association between sex and race

```{r dag2}
dag2 <- dagitty('dag {
"Baseline Mental Health Tx" [pos="-0.442,1.358"]
"Financial Comfort" [pos="0.763,0.442"]
"Inhibited Temperament" [pos="-0.431,-1.470"]
"Parent Education" [pos="0.330,-1.285"]
"Past Mental Health Problems" [pos="-0.425,-0.368"]
"Procrastination Tendency" [pos="-1.862,-0.222"]
"Race/Ethnicity" [pos="1.361,-1.587"]
"Student Status" [exposure,pos="-2.138,1.756"]
"Unobserved confounder" [latent,pos="-0.442,-1.882"]
Depression [outcome,pos="1.411,1.756"]
Sex [pos="-2.211,-1.594"]
"Baseline Mental Health Tx" -> "Student Status"
"Baseline Mental Health Tx" -> Depression
"Financial Comfort" -> "Baseline Mental Health Tx"
"Financial Comfort" -> "Student Status"
"Financial Comfort" -> Depression
"Inhibited Temperament" -> "Baseline Mental Health Tx" [pos="0.046,-1.049"]
"Inhibited Temperament" -> "Past Mental Health Problems" [pos="-0.420,-1.244"]
"Inhibited Temperament" -> "Procrastination Tendency"
"Inhibited Temperament" -> "Student Status" [pos="-1.546,0.163"]
"Inhibited Temperament" -> Depression [pos="1.080,0.015"]
"Parent Education" -> "Baseline Mental Health Tx"
"Parent Education" -> "Financial Comfort"
"Parent Education" -> "Past Mental Health Problems"
"Parent Education" -> "Student Status" [pos="-1.242,-0.129"]
"Parent Education" -> Depression [pos="1.170,-0.050"]
"Past Mental Health Problems" -> "Baseline Mental Health Tx" [pos="-0.425,0.041"]
"Past Mental Health Problems" -> "Student Status" [pos="-0.881,0.163"]
"Past Mental Health Problems" -> Depression
"Procrastination Tendency" -> "Baseline Mental Health Tx"
"Procrastination Tendency" -> "Past Mental Health Problems"
"Procrastination Tendency" -> "Student Status"
"Procrastination Tendency" -> Depression [pos="0.148,0.910"]
"Race/Ethnicity" -> "Baseline Mental Health Tx"
"Race/Ethnicity" -> "Financial Comfort"
"Race/Ethnicity" -> "Inhibited Temperament"
"Race/Ethnicity" -> "Parent Education"
"Race/Ethnicity" -> "Past Mental Health Problems"
"Race/Ethnicity" -> "Student Status"
"Race/Ethnicity" -> Depression
"Student Status" -> Depression
"Unobserved confounder" -> "Race/Ethnicity"
"Unobserved confounder" -> Sex
Sex -> "Baseline Mental Health Tx"
Sex -> "Inhibited Temperament"
Sex -> "Past Mental Health Problems"
Sex -> "Procrastination Tendency"
Sex -> Depression
}
')

plot( dag2 )
```

```{r}
impliedConditionalIndependencies( dag2 )
```



```{r}
dag2.imp1 <- polr( curfin.o ~ rcs( bisct, 3) + race2,
              Hess = T,
              data = ctsr.use.a1
              )
Anova( dag2.imp1 )

dag2.imp2 <- polr( curfin.o ~ mhpast + nocollege + race2,
              Hess = T,
              data = ctsr.use.a1
              )
Anova( dag2.imp2 )

dag2.imp3 <- polr( curfin.o ~ rcs( procrastct, 3 ) + rcs( bisct, 3 ) + sex,
              Hess = T,
              data = ctsr.use.a1
              )

Anova( dag2.imp3 )

dag2.imp4 <- polr( curfin.o ~ rcs( procrastct, 3 ) + race2,
              Hess = T,
              data = ctsr.use.a1
              )
Anova( dag2.imp4 )

dag2.imp5 <- polr( curfin.o ~ sex + race2,
              Hess = T,
              data = ctsr.use.a1
              )
Anova( dag2.imp5 )


dag2.imp6 <- lm( bisct ~ nocollege + race2,
              data = ctsr.use.a1
              )
Anova( dag2.imp6 )


dag2.imp7 <- glm( nocollege ~ rcs( procrastct, 3 ) + rcs( bisct, 3 ) + sex,
              data = ctsr.use.a1,
             family = binomial('logit')
              )
Anova( dag2.imp7 )


dag2.imp8 <- glm( nocollege ~ rcs( procrastct, 3 ) + race2,
              data = ctsr.use.a1,
             family = binomial('logit')
              )
Anova( dag2.imp8 )


dag2.imp8a <- glm( procrastct ~ nocollege + race2,
              data = ctsr.use.a1,
             family = gaussian('identity')
              )
Anova( dag2.imp8a )


dag2.imp9 <- glm( nocollege ~ sex + race2,
              data = ctsr.use.a1,
             family = binomial('logit')
              )
Anova( dag2.imp9 )


dag2.imp10 <- lm( procrastct ~ race2 + sex + rcs( bisct, 3 ),
              data = ctsr.use.a1
              )
Anova( dag2.imp10 )

ctsr.use.a1$transon <- ifelse( ctsr.use.a1$transfer.campus.f == 'Transfer: On Campus', 1, 0 ) 
ctsr.use.a1$transoff <- ifelse( ctsr.use.a1$transfer.campus.f == 'Transfer: Off Campus', 1, 0 ) 
ctsr.use.a1$firstyr <- ifelse( ctsr.use.a1$transfer.campus.f == 'First-Year', 1, 0 ) 

dag2.imp11a <- glm( transon ~ sex + txcur + curfin.o + nocollege + mhpast + rcs( procrastct, 3 ) + race2,
              data = ctsr.use.a1,
              'binomial'
              )
Anova( dag2.imp11a )

dag2.imp11b <- glm( transoff ~ sex + txcur + curfin.o + nocollege + mhpast + rcs( procrastct, 3 ) + race2,
              data = ctsr.use.a1,
              'binomial'
              )
Anova( dag2.imp11b )

dag2.imp11c <- glm( firstyr ~ sex + txcur + curfin.o + nocollege + mhpast + rcs( procrastct, 3 ) + race2,
              data = ctsr.use.a1,
              'binomial'
              )
Anova( dag2.imp11c )
```



View the minimally sufficient adjustment set implied by the DAG.
```{r adjset}
adjustmentSets( dag2 )
```

## Modeling Symptom Trajectorie

Redundancy analysis to evaluate the extent of multi-collinearity 
```{r redundancy}

redun( phq ~ transfer.campus.f + txcur + mhpast + curfin + procrastct + bisct + race2 + male + weeks + nocollege, data = ctsr.use.a1 )
```



```{r descriptives2}
#html( describe( ctsr.use ) )
```


**m0.symp: Complex poisson model**
This is a Poisson model, assuming a single parameters can capture both the conditional mean and variance in the outcome. This complex model includes:

* Random intercepts and slopes for linear time effect
* Nonlinear fixed effects for time
* Covariate by time interactions

```{r m0symp}

# m0.symp <- mixed_model( fixed = phq ~ transfer.campus.f*rcs( weeks, 3 )
#                 + txcur*rcs(  weeks, 3 )
#                 + procrastct*rcs(  weeks, 3 )
#                 + bisct*rcs(  weeks, 3 )
#                 + curfin
#                 + race2
#                 + male
#                 + nocollege
#                 + mhpast,
#                 random =~ weeks | id,
#                 data = ctsr.use,
#                 family = poisson()
#                 )
# 
# save( m0.symp, file = 'm0.symp.Rdata' )

load( 'm0.symp.Rdata' )
```


**m1.symp: Complex negative binomial model**

* Adds $df=1$ to *m0.symp* in the form of a $\theta$ parameter to capture overdispersion

```{r}

# m1.symp <- mixed_model( fixed = phq ~ transfer.campus.f*rcs( weeks, 3 )
#                 + txcur*rcs(  weeks, 3 )
#                 + procrastct*rcs(  weeks, 3 )
#                 + bisct*rcs(  weeks, 3 )
#                 + curfin
#                 + race2
#                 + male
#                 + nocollege
#                 + mhpast,
#                 random =~ weeks | id,
#                 data = ctsr.use,
#                 family = GLMMadaptive:::negative.binomial()
#                 )
# 
# save( m1.symp, file = 'm1.symp.Rdata' )
load( 'm1.symp.Rdata' )
```


**Compare Poisson & negative binomials models (m1.symp vs. m2.symp)**

* Addition of $\theta$ parameter substantially improves fit
* $\theta$ estimate is very large relative to its standard error 

```{r}
( lrt.m0symp.m1symp <- anova( m0.symp, m1.symp ) )
```



**m2.symp: Drop random slope** 

* Drop the random time effects
* Allow random variation around the intercept but not linear slope
* Results in a gain of $df=2$

```{r}

# m2.symp <- mixed_model( fixed = phq ~ transfer.campus.f*rcs( weeks, 3 )
#                 + txcur*rcs(  weeks, 3 )
#                 + procrastct*rcs(  weeks, 3 )
#                 + bisct*rcs(  weeks, 3 )
#                 + curfin
#                 + race2
#                 + male
#                 + nocollege
#                 + mhpast,
#                 random =~ 1 | id,
#                 data = ctsr.use,
#                 family = GLMMadaptive:::negative.binomial()
#                 )
# 
# save( m2.symp, file = 'm2.symp.Rdata' )
load( 'm2.symp.Rdata' )
```


**Compare models with & without random time slopes**

* Strong evidence in support of retention of random time slope

```{r}
( lrt.m1symp.m2symp <- anova( m1.symp, m2.symp ) )
```


**m3.symp: Drop interaction of current treatment & time**

* Drop interaction between baseline mental health treatment status and time
* Results in gain of $df=2$

```{r}

# m3.symp <- mixed_model( fixed = phq ~ transfer.campus.f*rcs( weeks, 3 )
#                 + txcur
#                 + procrastct*rcs(  weeks, 3 )
#                 + bisct*rcs(  weeks, 3 )
#                 + curfin
#                 + race2
#                 + male
#                 + nocollege
#                 + mhpast,
#                 random =~ weeks | id,
#                 data = ctsr.use,
#                 family = GLMMadaptive:::negative.binomial()
#                 )
# 
# save( m3.symp, file = 'm3.symp.Rdata' )
load( 'm3.symp.Rdata' )
```


**Compare models with & without txcur_x_weeks effect**

* Insufficient evidence to support retention of txcur*weeks interaction
* Drop this effect from future models 

```{r}
( lrt.m1symp.m3symp <- anova( m1.symp, m3.symp ) )
```

**m4.symp: Drop interaction of procrastination & time**
* Simplify model by dropping interaction of procrastination with time
* Results in gain of $df=2$

```{r}

# m4.symp <- mixed_model( fixed = phq ~ transfer.campus.f*rcs( weeks, 3 )
#                 + txcur
#                 + procrastct
#                 + bisct*rcs(  weeks, 3 )
#                 + curfin
#                 + race2
#                 + male
#                 + nocollege
#                 + mhpast,
#                 random =~ weeks | id,
#                 data = ctsr.use,
#                 family = GLMMadaptive:::negative.binomial()
#                 )
# 
# save( m4.symp, file = 'm4.symp.Rdata' )
load( 'm4.symp.Rdata' )
```

**Compare models with & without procrastct_x_weeks**

* Insufficient evidence to support retention of interaction
* Drop procrastct*weeks interaction from subsequent models

```{r}
( lrt.m3symp.m4symp <- anova( m3.symp, m4.symp ) )
```

**m5.symp: Drop interaction of inhibition & time**
* Simplify model by dropping effect of inhibition & its interaction with time
* Results in gain of $df=2$

```{r}

# m5.symp <- mixed_model( fixed = phq ~ transfer.campus.f*rcs( weeks, 3 )
#                 + txcur
#                 + procrastct
#                 + bisct
#                 + curfin
#                 + race2
#                 + male
#                 + nocollege
#                 + mhpast,
#                 random =~ weeks | id,
#                 data = ctsr.use,
#                 family = GLMMadaptive:::negative.binomial()
#                 )
# 
# save( m5.symp, file = 'm5.symp.Rdata' )
load( 'm5.symp.Rdata' )
```

**Compare models with & without bisct_x_weeks interaction**

* Insufficient evidence to support retention of interaction
* Drop from subsequent models

```{r}
( lrt.m4symp.m5symp <- anova( m4.symp, m5.symp ) )
```

**m6.symp: Drop nonlinear fixed time effect**

* Simplify model by making time effect linear
* Results in gain of $df=3$


```{r}

# m6.symp <- mixed_model( fixed = phq ~ transfer.campus.f*weeks
#                 + txcur
#                 + procrastct
#                 + bisct
#                 + curfin
#                 + race2
#                 + male
#                 + nocollege
#                 + mhpast,
#                 random =~ weeks | id,
#                 data = ctsr.use,
#                 family = GLMMadaptive:::negative.binomial()
#                 )
# 
# save( m6.symp, file = 'm6.symp.Rdata' )
load( 'm6.symp.Rdata' )
```


**Compare models with & without nonlinear fixed time effect**

* Model with nonlinear time effect is significantly better
* Retain nonlinear fixed time effect


```{r}
( lrt.m5symp.m6symp <- anova( m5.symp, m6.symp ) )
```

**m7.symp: Student status by time interaction**

* Tests major hypothesis that shape of trajectories will differ by student status

```{r}

# m7.symp <- mixed_model( fixed = phq ~ transfer.campus.f + rcs( weeks, 3 )
#                 + txcur
#                 + procrastct
#                 + bisct
#                 + curfin
#                 + race2
#                 + male
#                 + nocollege
#                 + mhpast,
#                 random =~ weeks | id,
#                 data = ctsr.use,
#                 family = GLMMadaptive:::negative.binomial()
#                 )
# 
# save( m7.symp, file = 'm7.symp.Rdata' )
load( 'm7.symp.Rdata' )
```


**Compare models with & without student status by time interaction**

* Model with interaction tends to be better & approaches statistical significance threshold without crossing it
* AIC is better in model with interaction


```{r}
( lrt.m7symp.m5symp <- anova( m7.symp, m5.symp ) )
```


**m8.symp: Student status altogether**
```{r}
# m8.symp <- mixed_model( fixed = phq ~ rcs( weeks, 3 )
#                 + txcur
#                 + procrastct
#                 + bisct
#                 + curfin
#                 + race2
#                 + male
#                 + nocollege
#                 + mhpast,
#                 random =~ weeks | id,
#                 data = ctsr.use,
#                 family = GLMMadaptive:::negative.binomial()
#                 )
# 
# save( m8.symp, file = 'm8.symp.Rdata' )
load( 'm8.symp.Rdata' )

```



**Compare models with & without student status main effect**

* Yields overall test of main effect of student status
* Model with student status not significantly better 
* AIC better without the main effect

```{r}
( lrt.m8symp.m7symp <- anova( m8.symp, m7.symp ) )
```

**Compare model without student status to one with both main effect & interaction**

* Yields overall test of student status & interactions together
* Model approaches but doesn't reach significance
* AIC better in model with student status main effect & time interaction than model without student status at all

```{r}
( lrt.m8symp.m6symp <- anova( m8.symp, m5.symp ) )
```


Plot predicted PHQ-8 scores based on m5.symp
```{r fig.width=14, fig.height=10}


# m5.symppred <- ggpredict( m5.symp, term=c('weeks [all]','transfer.campus.f'), type = 'fe' )
# save( m5.symppred, file = 'm5.symppred.RData'  )
load( 'm5.symppred.RData' )

cbbPalette <- c("#000000", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7")


symp.predplot <- ggplot( m5.symppred, aes(x, predicted, colour = group, fill = group ) ) + 
  geom_line( size = 1.25) +
  geom_ribbon(aes(ymin = conf.low, ymax = conf.high ), alpha = .1, show.legend = F, linetype = 3 ) +
  labs( x = 'Week of the Fall Semester',
    y = 'PHQ-8 Total Depressive Symptom Score',
    colour = 'Student Type',
    title = 'Model-Predicted Mean Depressive Symptom Trajectories',
    subtitle = 'Based on Mixed-Effects Negative Binomial Model',
    caption = 'Adjusts for past need for mental health support, baseline mental health treatment, race, sex, inhibition, procrastination, parent education & financial comfort') +
  theme( plot.title = element_text( face = 'bold', size = 18, color = 'darkblue', hjust = .5),
         axis.title = element_text( size = 14),
         legend.title = element_text( size = 14, face = 'bold'),
         plot.subtitle = element_text( size = 14, face = 'bold', hjust = .5),
         legend.key.size = unit(1, 'cm'),
         legend.text = element_text( size = 12),
         plot.caption = element_text( size = 12)) +
  scale_fill_manual(values=cbbPalette) +
  scale_color_manual(values = cbbPalette ) +
  geom_vline( xintercept = 0, color = 2 )

symp.predplot  


# ggsave(
#   filename = 'sympplot.tiff',
#   plot = last_plot(),
#   device = 'tiff',
#   dpi = 300,
#   limitsize = TRUE,
#   width = 12,
#   height = 10
# )
```


Plot random intercepts by model predictors to detect signs of violations of assumption of independence between them
```{r}
m5.symp.re <- data.frame( ranef( m5.symp ) )
m5.symp.re$id <- row.names( m5.symp.re )
colnames( m5.symp.re )[1:2] <- c( 'Intercept','Slope' )

m5.symp.re1 <- merge( m5.symp.re, ctsr.use.a1, all.x = T, all.y = F )
plot( m5.symp.re1$weeks, m5.symp.re1$Intercept )

re.i.weeks <- ggplot( m5.symp.re1, aes( weeks, Intercept ) ) +
  geom_smooth( )+
  geom_point()



re.i.transfer <- ggplot( m5.symp.re1, aes( Intercept, transfer.campus.f ) ) +
    geom_boxplot( notch = T  )+
  geom_point()


re.i.pro <- ggplot( m5.symp.re1, aes( procrastct, Intercept ) ) +
  geom_smooth( ) +
  geom_point()


re.i.bis <- ggplot( m5.symp.re1, aes( bisct, Intercept ) ) +
  geom_point( ) +
  geom_smooth( )


re.i.curfin <- ggplot( m5.symp.re1, aes( Intercept, curfin ) ) +
    geom_boxplot( notch = T  )+
  geom_point()


re.i.race <- ggplot( m5.symp.re1, aes( Intercept, race2 ) ) +
    geom_boxplot( notch = T  )+
  geom_point()


re.i.parented <- ggplot( m5.symp.re1, aes( Intercept, nocollege ) ) +
    geom_boxplot( notch = T  )+
  geom_point()


re.i.sex <- ggplot( m5.symp.re1, aes( Intercept, sex ) ) +
    geom_boxplot( notch = T  )+
  geom_point()


re.i.mhpast <- ggplot( m5.symp.re1, aes( Intercept, mhpast ) ) +
  geom_boxplot( notch = T )+
  geom_point()


cowplot::plot_grid( re.i.bis, re.i.curfin, re.i.mhpast, re.i.parented,
                    re.i.pro, re.i.race, re.i.sex, re.i.transfer, re.i.weeks,
                    nrow = 3, ncol = 3 )
```


Plot random slopes (time effect) by model predictors to detect signs of violations of assumption of independence between them
```{r}
re.s.weeks <- ggplot( m5.symp.re1, aes( weeks, Slope ) ) +
  geom_smooth( )+
  geom_point()

re.s.transfer <- ggplot( m5.symp.re1, aes( Slope, transfer.campus.f ) ) +
    geom_boxplot( notch = T  )+
  geom_point()


re.s.pro <- ggplot( m5.symp.re1, aes( procrastct, Slope ) ) +
  geom_smooth( ) +
  geom_point()


re.s.bis <- ggplot( m5.symp.re1, aes( bisct, Slope ) ) +
  geom_point( ) +
  geom_smooth( )


re.s.curfin <- ggplot( m5.symp.re1, aes( Slope, curfin ) ) +
    geom_boxplot( notch = T  )+
  geom_point()
re.s.curfin

re.s.race <- ggplot( m5.symp.re1, aes( Slope, race2 ) ) +
    geom_boxplot( notch = T  )+
  geom_point()


re.s.parented <- ggplot( m5.symp.re1, aes( Slope, nocollege ) ) +
    geom_boxplot( notch = T  )+
  geom_point()


re.s.sex <- ggplot( m5.symp.re1, aes( Slope, sex ) ) +
    geom_boxplot( notch = T  )+
  geom_point()


re.s.mhpast <- ggplot( m5.symp.re1, aes( Slope, mhpast ) ) +
  geom_boxplot( notch = T )+
  geom_point()


cowplot::plot_grid( re.s.bis, re.s.curfin, re.s.mhpast, re.s.parented,
                    re.s.pro, re.s.race, re.s.sex, re.s.transfer, re.s.weeks,
                    nrow = 3, ncol = 3 )
```



**m9.symp: Exclude off-campus first-years**
* Exclude off-campus first-year students ($n=16$) from the analysis to see if their inclusion is muting the effect of being a first-year vs. being a transfer student
* Effects are highly similar when excluding these students

```{r}

ctsr.use$fycampus <- ifelse( ctsr.use$transfer == 'First-Year' & ctsr.use$campus == 'Off Campus', 1, 0 )


ctsr.use.nofyoff <- subset( ctsr.use, fycampus == 0 )

# m9.symp <- mixed_model( fixed = phq ~ transfer.campus.f*rcs( weeks, 3 )
#                 + txcur
#                 + procrastct
#                 + bisct
#                 + curfin
#                 + race2
#                 + male
#                 + nocollege
#                 + mhpast,
#                 random =~ weeks | id,
#                 data = ctsr.use.nofyoff ,
#                 family = GLMMadaptive:::negative.binomial()
#                 )
# 
# save( m9.symp, file = 'm9.symp.Rdata' )
load( 'm9.symp.Rdata' )
```


**m10.symp: Marker of risk**

* Possible that being a transfer and living off campus are markers of risk but not causal factors
* Remove potential confounding factors that school administrators would not have access to
* Still insufficient evidence to conclude that  

```{r}
# m10.symp <- mixed_model( fixed = phq ~ transfer.campus.f*rcs( weeks, 3 )
#                 + curfin
#                 + race2
#                 + male
#                 + nocollege,
#                 random =~ weeks | id,
#                 data = ctsr.use,
#                 family = GLMMadaptive:::negative.binomial()
#                 )
# 
# save( m10.symp, file = 'm10.symp.Rdata' )
load( 'm10.symp.Rdata' )
```


**m11.symp: Drop effect of student status from m10.symp**

* Drop effects of student status to get overall estimate of effect with likelihood ratio test

```{r}
# m11.symp <- mixed_model( fixed = phq ~ rcs( weeks, 3 )
#                 + curfin
#                 + race2
#                 + male
#                 + nocollege,
#                 random =~ weeks | id,
#                 data = ctsr.use,
#                 family = GLMMadaptive:::negative.binomial()
#                 )
# 
# 
# save( m11.symp, file = 'm11.symp.Rdata' )
load( 'm11.symp.Rdata' )
```


**Compare m10.symp & m11.symp to test overall effect of student status**

* Model with student status & interactions significantly better than model without it
* AIC better when including student status & interaction effects

```{r}
( lrt.m10symp.m11symp <- anova( m10.symp, m11.symp ) )
```



## Model Role Functioning Trajectories


### Data Preparation

Setup data for continuation ratio ordinal mixed-effects logistic regression analyses.

```{r}
cr.vals.role <- cr_setup( ctsr.use$roleemot )
cr.data <- ctsr.use[cr.vals.role$subs, ]
cr.data$roleemot.new <- cr.vals.role$y
cr.data$cohort <- cr.vals.role$cohort
```


**m0.role: Most complex model**

* Includes nonlinear time effects
* Random effects for intercept & linear time effect & correlation among these variance components
* Interactions between plausible confounders and time

```{r}
# m0.role <- mixed_model( fixed = roleemot.new ~ transfer.campus.f*rcs( weeks, 3 )
#                 + txcur*rcs(  weeks, 3 )
#                 + procrastct*rcs(  weeks, 3 )
#                 + bisct*rcs(  weeks, 3 )
#                 + curfin
#                 + race2
#                 + male
#                 + cohort
#                 + mhpast
#                 + nocollege,
#                 random =~ weeks | id,
#                 data = cr.data,
#                 family = binomial()
#                 )
# 
# save( m0.role, file = 'm0.role.Rdata' )
load( 'm0.role.Rdata' )

```



**m1.role: Drop random time slope**


```{r}
# m1.role <- mixed_model( fixed = roleemot.new ~ transfer.campus.f*rcs( weeks, 3 )
#                 + txcur*rcs(  weeks, 3 )
#                 + procrastct*rcs(  weeks, 3 )
#                 + bisct*rcs(  weeks, 3 )
#                 + curfin
#                 + race2
#                 + male
#                 + cohort
#                 + mhpast
#                 + nocollege,
#                 random =~ 1 | id,
#                 data = cr.data,
#                 family = binomial()
#                 )
# 
# save( m1.role, file = 'm1.role.Rdata' )
load( 'm1.role.Rdata' )
```


**Compare m0.role & m1.role** 

* Retain random slope for time effect

```{r}
( lrt.m1role.m0role <- anova( m1.role, m0.role ) )
```

**m2.role: Drop interaction of txcur & time**

```{r}
# m2.role <- mixed_model( fixed = roleemot.new ~ transfer.campus.f*rcs( weeks, 3 )
#                 + txcur
#                 + procrastct*rcs(  weeks, 3 )
#                 + bisct*rcs(  weeks, 3 )
#                 + curfin
#                 + race2
#                 + male
#                 + cohort
#                 + mhpast
#                 + nocollege,
#                 random =~ weeks | id,
#                 data = cr.data,
#                 family = binomial()
#                 )
# 
# save( m2.role, file = 'm2.role.Rdata' )
load( 'm2.role.Rdata' )
```


**Compare m2.role to m0.role**
```{r}
( lrt.m2role.m0role <- anova( m2.role, m0.role ) )
```

**Drop interaction of procrastination & time**

```{r}
# m3.role <- mixed_model( fixed = roleemot.new ~ transfer.campus.f*rcs( weeks, 3 )
#                 + txcur
#                 + procrastct
#                 + bisct*rcs(  weeks, 3 )
#                 + curfin
#                 + race2
#                 + male
#                 + cohort
#                 + mhpast
#                 + nocollege,
#                 random =~ weeks | id,
#                 data = cr.data,
#                 family = binomial()
#                 )
# 
# save( m3.role, file = 'm3.role.Rdata' )
load( 'm3.role.Rdata' )
```


**Compare m3.role to m2.role**

```{r}
( lrt.3role.m2role <- anova( m3.role, m2.role ) )
```

**Drop interaction of inhibition & time**

```{r}
# m4.role <- mixed_model( fixed = roleemot.new ~ transfer.campus.f*rcs( weeks, 3 )
#                 + txcur
#                 + procrastct
#                 + bisct
#                 + curfin
#                 + race2
#                 + male
#                 + cohort
#                 + mhpast
#                 + nocollege,
#                 random =~ weeks | id,
#                 data = cr.data,
#                 family = binomial()
#                 )
# save( m4.role, file = 'm4.role.Rdata' )

load( 'm4.role.Rdata' )
```


**Compare m4.role to m3.role**

```{r}
( lrt.m4role.m3role <- anova( m4.role, m3.role ) )
```


**Drop nonlinear fixed time effects**

```{r}
# m5.role <- mixed_model( fixed = roleemot.new ~ transfer.campus.f*weeks
#                 + txcur
#                 + procrastct
#                 + bisct
#                 + curfin
#                 + race2
#                 + male
#                 + cohort
#                 + mhpast
#                 + nocollege,
#                 random =~ weeks | id,
#                 data = cr.data,
#                 family = binomial()
#                 )
# save( m5.role, file = 'm5.role.Rdata' )

load( 'm5.role.Rdata' )



# 
# m5a.role <- mixed_model( ordered( roleemot ) ~ transfer.campus.f*weeks
#                 + txcur
#                 + procrastct
#                 + bisct
#                 + curfin
#                 + race2
#                 + male
#                 + cohort
#                 + mhpast
#                 + nocollege,
#                 random =~ weeks | id,
#                 data = ctsr.use,
#                 family = binomial("logit")
#                 )
# save( m5a.role, file = 'm5a.role.Rdata' )

load( 'm5a.role.Rdata' )
```


**Compare m5.role to m4.role**

```{r}
( lrt.m5role.m4role <- anova( m5.role, m4.role ) )
```


**Drop student status by time interaction**


```{r}
# m6.role <- mixed_model( fixed = roleemot.new ~ transfer.campus.f + weeks
#                 + txcur
#                 + procrastct
#                 + bisct
#                 + curfin
#                 + race2
#                 + male
#                 + cohort
#                 + mhpast
#                 + nocollege,
#                 random =~ weeks | id,
#                 data = cr.data,
#                 family = binomial()
#                 )
# save( m6.role, file = 'm6.role.Rdata' )

load( 'm6.role.Rdata' )
```


**Overall test interaction between student status & time**

```{r}
( lrt.m6role.m5arole <- anova( m6.role, m5.role ) )
```

**Drop student status altogether**

```{r}
# m7.role <- mixed_model( fixed = roleemot.new ~  weeks
#                 + txcur
#                 + procrastct
#                 + bisct
#                 + curfin
#                 + race2
#                 + male
#                 + cohort
#                 + mhpast
#                 + nocollege,
#                 random =~ weeks | id,
#                 data = cr.data,
#                 family = binomial()
#                 )
# save( m7.role, file = 'm7.role.Rdata' )

load( 'm7.role.Rdata' )
```


**Test of main effect of student status**

```{r}
( lrt.m7role.m6role <- anova( m7.role, m6.role ) )
```


**Test of overall effect of student status including interaction**

```{r}
( lrt.m7role.m5role <- anova( m7.role, m5.role ) )
```



**m8.role: Refit m5.role testing parallel slopes**
```{r}
# m8.role <- mixed_model( fixed = roleemot.new ~ transfer.campus.f*weeks
#                 + txcur
#                 + procrastct
#                 + bisct
#                 + curfin
#                 + race2
#                 + male
#                 + cohort*transfer.campus.f
#                 + mhpast
#                 + nocollege,
#                 random =~ weeks | id,
#                 data = cr.data,
#                 family = binomial()
#                 )
# 
# save( m8.role, file = 'm8.role.Rdata' )
load( 'm8.role.Rdata' )
```

**Test non-parallel slopes**
No evidence for non-parallel slopes for effect of transfer.campus.f
```{r}
anova( m5.role, m8.role )
```


```{r fig.width=12, fig.height=10}


nDF <- with(cr.data, expand.grid( weeks = seq(-2, 15, by = .5 ),
                                  transfer.campus.f = levels( transfer.campus.f ),
                                  txcur = 'No',
                                  procrastct = 0,
                                  bisct = 0,
                                  curfin = 'Tight but fine',
                                  race2 = 'White/Caucasian',
                                  male = 0,
                                  cohort = levels( cohort),
                                  mhpast = 'No',
                                  nocollege = 'College Degree'
)
)
 
# plot_data_m <- effectPlotData( m5.role,
#                                nDF,
#                                CR_cohort_varname = "cohort",
#                               direction = "forward",
#                               marginal = TRUE,
#                               cores = 2 )
# save( plot_data_m, file = 'plot_data_m.RData' )
load( 'plot_data_m.RData' )

plot_data_m$ordinal_responsef <- factor( plot_data_m$ordinal_response, 
                                         levels = 1:4,
                                         labels = c('0 Impairment Items','1 Impairment Item','2 Impairment Items','3 Impairment Items')
                                         )

expit <- function (x) exp(x) / (1 + exp(x))
my_panel_bands <- function(x, y, upper, lower, fill, col, subscripts, ..., font, 
                           fontface) {
  upper <- upper[subscripts]
  lower <- lower[subscripts]
  panel.polygon(c(x, rev(x)), c(upper, rev(lower)), col = fill, border = FALSE, ...)
}

plot_data_m$prob <- expit( plot_data_m$pred )
plot_data_m$prob.up <- expit( plot_data_m$upp )
plot_data_m$prob.low <- expit( plot_data_m$low )


cbbPalette <- c("#000000", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7")

m5.role.probplot <- ggplot( plot_data_m, aes( weeks, prob, group = ordinal_responsef, color = ordinal_responsef, fill = ordinal_responsef))+
  geom_line( size = 2 )+
  geom_ribbon(aes(ymin= prob.low,ymax=prob.up,alpha=0.5) ) +
  facet_wrap( ~transfer.campus.f ) +
  labs( title = 'Predicted Probabilities of Role Impairment',
        y = 'Marginal Probabilities',
        x = 'Week of the Academic Semester',
        subtitle = 'Based on Generalized Linear Mixed-Effects Model',
        caption = 'Effects adjusted for past mental health problems, baseline mental health treatment, race, sex, inhibition, procrastination, parent education & current financial comfort\nPredictions marginalized over random effects\nVertical red line indicates start of the academic semester (time=0)',
        fill = 'Total Impairment Items Reported',
        color = 'Total Impairment Items Reported' ) +
  theme( plot.title = element_text( color = 'darkblue', face = 'bold', size = 18, hjust = 0.5),
         plot.subtitle = element_text( face = 'bold', size = 14, hjust = 0.5),
         strip.text = element_text( size = 14, face = 'bold' ),
         axis.title = element_text( size = 13, face = 'bold'),
         legend.title = element_text( face = 'bold', size = 14),
         legend.text = element_text( size = 12 ),
         plot.caption = element_text( size = 11, hjust = 0 ),
         legend.position = 'bottom' ) +
  scale_fill_manual(values=cbbPalette) +
  scale_color_manual(values = cbbPalette ) +
  geom_vline( xintercept = 0, color = 2 ) +
  guides( alpha = F )
m5.role.probplot 
```

Plot random intercepts by model predictors to detect signs of violations of assumption of independence between them
```{r}
m5.role.re <- data.frame( ranef( m5.role ) )
m5.role.re$id <- row.names( m5.role.re )
colnames( m5.role.re )[1:2] <- c( 'Intercept','Slope' )

m5.role.re1 <- merge( m5.role.re, ctsr.use.a1, all.x = T, all.y = F )
plot( m5.role.re1$weeks, m5.role.re1$Intercept )

role.re.i.weeks <- ggplot( m5.role.re1, aes( weeks, Intercept ) ) +
  geom_smooth( )+
  geom_point()



role.re.i.transfer <- ggplot( m5.role.re1, aes( Intercept, transfer.campus.f ) ) +
    geom_boxplot( notch = T  )+
  geom_point()


role.re.i.pro <- ggplot( m5.role.re1, aes( procrastct, Intercept ) ) +
  geom_smooth( ) +
  geom_point()


role.re.i.bis <- ggplot( m5.role.re1, aes( bisct, Intercept ) ) +
  geom_point( ) +
  geom_smooth( )


role.re.i.curfin <- ggplot( m5.role.re1, aes( Intercept, curfin ) ) +
    geom_boxplot( notch = T  )+
  geom_point()


role.re.i.race <- ggplot( m5.role.re1, aes( Intercept, race2 ) ) +
    geom_boxplot( notch = T  )+
  geom_point()


role.re.i.parented <- ggplot( m5.role.re1, aes( Intercept, nocollege ) ) +
    geom_boxplot( notch = T  )+
  geom_point()


role.re.i.sex <- ggplot( m5.role.re1, aes( Intercept, sex ) ) +
    geom_boxplot( notch = T  )+
  geom_point()


role.re.i.mhpast <- ggplot( m5.role.re1, aes( Intercept, mhpast ) ) +
  geom_boxplot( notch = T )+
  geom_point()


cowplot::plot_grid( role.re.i.bis, role.re.i.curfin, role.re.i.mhpast, role.re.i.parented,
                    role.re.i.pro, role.re.i.race, role.re.i.sex, role.re.i.transfer, role.re.i.weeks,
                    nrow = 3, ncol = 3 )
```


## Modeling Social Impairment Trajectories

```{r}
cr.vals.social <- cr_setup( ctsr.use$socactiv )
cr.data.soc <- ctsr.use[cr.vals.social$subs, ]
cr.data.soc$socactiv.new <- cr.vals.social$y
cr.data.soc$cohort <- cr.vals.social$cohort
```


Most complex model. Originally we attempted to fit this model with interactions between several adjustment variables (*txcur*, *procrastct*, & *bisct*) and time, but the model did not converge. We simplified the model by removing these interactions. We add these interactions back in **m2.social** below.
```{r}
# m0.social <- mixed_model( fixed = socactiv.new ~ transfer.campus.f*rcs( weeks, 3 )
#                 + txcur*rcs( weeks, 3 )
#                 + procrastct*rcs( weeks, 3 )
#                 + bisct*rcs( weeks, 3 )
#                 + curfin
#                 + race2
#                 + male
#                 + cohort
#                 + mhpast,
#                 random =~ weeks | id,
#                 data = cr.data.soc,
#                 family = binomial()
#                 )
# 
# save( m0.social, file = 'm0.social.Rdata' )
load( 'm0.social.Rdata' )

```


Drop random time slopes
```{r}
# m1.social <- mixed_model( fixed = socactiv.new ~ transfer.campus.f*rcs( weeks, 3 )
#                 + txcur*rcs( weeks, 3 )
#                 + procrastct*rcs( weeks, 3 )
#                 + bisct*rcs( weeks, 3 )
#                 + curfin
#                 + race2
#                 + male
#                 + cohort
#                 + mhpast,
#                 random =~ 1 | id,
#                 data = cr.data.soc,
#                 family = binomial()
#                 )
# 
# save( m1.social, file = 'm1.social.Rdata' )
load( 'm1.social.Rdata' )
```


```{r}
anova( m0.social, m1.social )
```


Drop baseline treatment by time interaction
```{r}
# m2.social <- mixed_model( fixed = socactiv.new ~ transfer.campus.f*rcs( weeks, 3 )
#                 + txcur
#                 + procrastct*rcs( weeks, 3 )
#                 + bisct*rcs( weeks, 3 )
#                 + curfin
#                 + race2
#                 + male
#                 + cohort
#                 + mhpast,
#                 random =~ weeks | id,
#                 data = cr.data.soc,
#                 family = binomial()
#                 )
# 
# save( m2.social, file = 'm2.social.Rdata' )
load( 'm2.social.Rdata' )
```


```{r}
anova( m0.social, m2.social )
```


Drop procrastination by time interaction
```{r}
# m3.social <- mixed_model( fixed = socactiv.new ~ transfer.campus.f*rcs( weeks, 3 )
#                 + txcur
#                 + procrastct
#                 + bisct*rcs( weeks, 3 )
#                 + curfin
#                 + race2
#                 + male
#                 + cohort
#                 + mhpast,
#                 random =~ weeks | id,
#                 data = cr.data.soc,
#                 family = binomial()
#                 )
# 
# save( m3.social, file = 'm3.social.Rdata' )
load( 'm3.social.Rdata' )
```


```{r}
anova( m2.social, m3.social )
```





Drop interactions between time and inhibition
```{r}
# m4.social <- mixed_model( fixed = socactiv.new ~ transfer.campus.f*rcs( weeks, 3 )
#                 + txcur
#                 + procrastct
#                 + bisct
#                 + curfin
#                 + race2
#                 + male
#                 + cohort
#                 + mhpast,
#                 random =~ weeks | id,
#                 data = cr.data.soc,
#                 family = binomial()
#                 )
# save( m4.social, file = 'm4.social.Rdata' )

load( 'm4.social.Rdata' )
```

```{r}
anova( m3.social, m4.social )
```

Drop nonlinear fixed effect of time
```{r}
# m5.social <- mixed_model( fixed = socactiv.new ~ transfer.campus.f*weeks
#                 + txcur
#                 + procrastct
#                 + bisct
#                 + curfin
#                 + race2
#                 + male
#                 + cohort
#                 + mhpast,
#                 random =~ weeks | id,
#                 data = cr.data.soc,
#                 family = binomial()
#                 )
# save( m5.social, file = 'm5.social.Rdata' )

load( 'm5.social.Rdata' )



# m5a.social <- clmm( socactiv ~ transfer.campus.f*weeks
#                 + txcur
#                 + procrastct
#                 + bisct
#                 + curfin
#                 + race2
#                 + male
#                 + cohort
#                 + mhpast
#                 + ( weeks | id ),
#                 data = ctsr.use,
#                 Hess = T,
#                 family = binomial('logit')
#                 )
# save( m5a.social, file = 'm5a.social.Rdata' )
```


```{r}
anova( m4.social, m5.social )
```

Drop interaction of student status and time
```{r}
# m6.social <- mixed_model( fixed = socactiv.new ~ transfer.campus.f + weeks
#                 + txcur
#                 + procrastct
#                 + bisct
#                 + curfin
#                 + race2
#                 + male
#                 + cohort
#                 + mhpast,
#                 random =~ weeks | id,
#                 data = cr.data.soc,
#                 family = binomial()
#                 )
# save( m6.social, file = 'm6.social.Rdata' )

load( 'm6.social.Rdata' )
```

```{r}
anova( m5.social, m6.social )
```



Drop nonlinear fixed linear effects of time
```{r}
# m7.social <- mixed_model( fixed = socactiv.new ~ weeks
#                 + txcur
#                 + procrastct
#                 + bisct
#                 + curfin
#                 + race2
#                 + male
#                 + cohort
#                 + mhpast,
#                 random =~ weeks | id,
#                 data = cr.data.soc,
#                 family = binomial()
#                 )
# 
# save( m7.social, file = 'm7.social.Rdata' )
load( 'm7.social.Rdata' )
```

```{r}
anova( m5.social, m7.social )
```

Check parallel slopes assumption
```{r}
# m8.social <- mixed_model( fixed = socactiv.new ~ transfer.campus.f*weeks
#                 + txcur
#                 + procrastct
#                 + bisct
#                 + curfin
#                 + race2
#                 + male
#                 + cohort*transfer.campus.f
#                 + mhpast,
#                 random =~ weeks | id,
#                 data = cr.data.soc,
#                 family = binomial()
#                 )
# save( m8.social, file = 'm8.social.Rdata' )

load( 'm8.social.Rdata' )
```


```{r}
anova( m5.social, m8.social )
```




```{r}


# nDF2 <- with(cr.data.soc, expand.grid( weeks = seq(-2, 15, by = .5 ),
#                                   transfer.campus.f = levels( transfer.campus.f ),
#                                   txcur = 'No',
#                                   procrastct = 0,
#                                   bisct = 0,
#                                   curfin = 'Tight but fine',
#                                   race2 = 'White/Caucasian',
#                                   male = 0,
#                                   cohort = levels( cohort),
#                                   mhpast = 'No',
#                                   nocollege = 'College Degree'
# )
# )
# 
# plot_data_m_social <- effectPlotData( object = m5.social,
#                                newdata = nDF2,
#                                CR_cohort_varname = 'cohort',
#                                direction = "forward",
#                                marginal = TRUE,
#                                cores = 2
#                                )
# save( plot_data_m_social, file = 'plot_data_m_social.RData' )
# load( 'plot_data_m.RData' )



```



```{r fig.height=10, fig.width=12}

m5.role.or <- exp( -confint( m5.role )[2:3,] )
ref <- c(1,1,1)
m5.role.or1 <- rbind( ref, m5.role.or )

m5.social.or <- exp( -confint( m5.social )[2:3,] )
m5.social.or1 <- rbind( ref, m5.social.or ) 

func.or <- rbind( m5.role.or1, m5.social.or1 )
colnames( func.or ) <- c('low','est','up')
func.or

lab <- rep( c( 'First-Year\n(reference level)','Transfer: On Campus','Transfer: Off Campus'), 2 )

func.or2 <- data.frame( cbind( func.or, lab ) )
func.or2$order <- rep( seq( 1, 3, 1 ), 2 )
func.or2$out <- rep( c('Role Impairment','Social Impairment'), each = 3 )

options( digits = 2 )

func.or2$low <- as.numeric( func.or2$low )
func.or2$up <- as.numeric( func.or2$up )
func.or2$est <- as.numeric( func.or2$est )

or.plot <- ggplot( func.or2, aes( est, order ) ) +
  geom_point( size = 2 ) +
  geom_segment( aes( x = low, xend = up, y = order, yend = order ) ) +
  facet_wrap( ~out ) +
  scale_y_continuous( breaks = c( 1, 2, 3 ),
                      labels = c( 'First-Year\n(reference level)','Transfer: On Campus','Transfer: Off Campus' ),
                      name = '') +
  # scale_x_continuous( breaks = c( 1, 2, 3 ),
  #                     labels = levels( factor( func.or2$lab ) ),
  #                     name = '') +
  geom_vline( xintercept = 1, col = 2 ) +
  labs( title = 'Effects on Depression-Related Impairment at Semester Outset',
        subtitle = 'Based on Generalized Linear Mixed-Effects Model',
        x = 'Adjusted Odds Ratio (95% Confidence Intervals)',
        caption = 'Effects adjusted for past mental health problems, baseline mental health treatment, race, sex, inhibition, procrastination, parent education & current financial comfort' ) +
  theme( plot.title = element_text( color = 'darkblue', size = 18, face = 'bold', hjust = 0.5 ),
         plot.subtitle = element_text( face = 'bold', size = 14, hjust = 0.5),
         axis.title.x = element_text( size = 12, face = 'bold' ),
         strip.text = element_text( size = 14 ),
         plot.caption = element_text( size = 11, hjust = 0 ),
         axis.text.y = element_text( size = 12 ) )
or.plot

```

Calculate E-values to determine how robust effects are to residual confounding
```{r}
require( EValue )


e.rare <- evalue( est = OR( func.or2[ func.or2$lab == 'Transfer: On Campus' & func.or2$out == 'Role Impairment', 'est' ], rare = T ),
        lo = OR( func.or2[ func.or2$lab == 'Transfer: On Campus' & func.or2$out == 'Role Impairment', 'up' ], rare = T ),
        hi = OR( func.or2[ func.or2$lab == 'Transfer: On Campus' & func.or2$out == 'Role Impairment', 'low' ], rare = T )
       )
e.notrare <- evalue( est = OR( func.or2[ func.or2$lab == 'Transfer: On Campus' & func.or2$out == 'Role Impairment', 'est' ], rare = F ),
        lo = OR( func.or2[ func.or2$lab == 'Transfer: On Campus' & func.or2$out == 'Role Impairment', 'up' ], rare = F ),
        hi = OR( func.or2[ func.or2$lab == 'Transfer: On Campus' & func.or2$out == 'Role Impairment', 'low' ], rare = F )
       )

list( e.rare, e.notrare )
```


```{r}
html( summaryM(roleemot ~ assess, data=ctsr.use ) )
```



# Study 3: Healthy Minds

```{r}
load("C:/Users/brunw/Dropbox/Research/R/HealthyMinds/2015.08/hmfin3.RData")
load("C:/Users/brunw/Dropbox/Research/R/HealthyMinds/2015.08/hm.merge.fy.nm.RData")
```



```{r}
hm.use <- hmfin[, c('respid'
                    ,
                    'schoolf'
                    ,
                    'survey_year'
                    ,
                    'nrweight'
                    ,
                    'age'
                    ,
                    'gender'
                    ,
                    'sex.smb'
                    ,
                    'race.smb'
                    ,
                    'intnat.smb'
                    ,
                    'hetero.smb'
                    ,
                    'fincur.smb'
                    ,
                    'finpast.smb'
                    ,
                    'momed.smb'
                    ,
                    'daded.smb'
                    ,
                    'relig.smb'
                    ,
                    'rel.smb'
                    ,
                    'dxany.smb'
                    ,
                    'age.smb'
                    ,
                    'year.smb'
                    ,
                     'age1819'
                    ,
                    'age20plus'
                     ,
                     'momcol.smb'
                    ,
                    'dadcol.smb'
                    ,
                    'offcampus'
                    ,
                    'deprawsc'
                    ,
                    'dep_impa'
                    )
                ]

hm.use$parcoll <- NA
hm.use$parcoll[ hm.use$momcol.smb == 1 ] <- 1
hm.use$parcoll[ hm.use$dadcol.smb == 1 ] <- 1
hm.use$parcoll[ hm.use$momcol.smb == 0 & hm.use$dadcol.smb == 0 ] <- 0

hm.use$agef.smb <- factor( hm.use$age.smb )
hm.use$fincurf.smb <- factor( hm.use$fincur.smb )
hm.use$depimpa.smb <- ordered( hm.use$dep_impa, exclude = 'asked but not answered' )
contrasts( hm.use$fincurf.smb ) <- contr.treatment( 3 )
```




```{r}
# hm1.symp <- mixed_model( fixed = deprawsc ~ year.smb 
#                 + offcampus*age20plus*dxany.smb
#                 + sex.smb
#                 + race.smb
#                 + intnat.smb
#                 + hetero.smb
#                 + fincurf.smb
#                 + dxany.smb
#                 ,
#                 random =~ offcampus | schoolf,
#                 data = hm.use,
#                 family = GLMMadaptive:::negative.binomial()
#                 )
# 
# save( hm1.symp, file = 'hm1.symp.Rdata' )
load( 'hm1.symp.Rdata' )

```



```{r}
# hm2.symp <- mixed_model( fixed = deprawsc ~ year.smb 
#                 + offcampus*age20plus*dxany.smb
#                 + sex.smb
#                 + race.smb
#                 + intnat.smb
#                 + hetero.smb
#                 + fincurf.smb
#                 + dxany.smb
#                 ,
#                 random =~ 1 | schoolf,
#                 data = hm.use,
#                 family = GLMMadaptive:::negative.binomial()
#                 )
# 
# save( hm2.symp, file = 'hm2.symp.Rdata' )
load( 'hm2.symp.Rdata' )


```


```{r}
# hm2a.symp <- mixed_model( fixed = deprawsc ~ year.smb
#                 + offcampus*age1819*dxany.smb
#                 + sex.smb
#                 + race.smb
#                 + intnat.smb
#                 + hetero.smb
#                 + fincurf.smb
#                 + dxany.smb
#                 ,
#                 random =~ 1 | schoolf,
#                 data = hm.use,
#                 family = GLMMadaptive:::negative.binomial()
#                 )

#save( hm2a.symp, file = 'hm2a.symp.Rdata' )
load( 'hm2a.symp.Rdata' )
```




```{r}


# hm2.symppred <- ggpredict( hm2.symp, term=c('age20plus','offcampus'), type = 'fe' )
# save( hm2.symppred, file = 'hm2.symppred.RData'  )
load( 'hm2.symppred.RData' )

cbbPalette <- c("#000000", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7")


p <- plot( hm2.symppred ) +
  labs( title = 'Predicted Depression Score by Living Situation and Age',
        y = 'Predicted PHQ-9 Total Score',
        x = 'Age Group (Years)',
        color = 'Living Situation',
        subtitle = 'Based on Generalized Linear Mixed-Effects Model',
        caption = 'Adjusted for survey year, past mental health diagnosis, sex, race, international student status, LGBTQ+ status, & financial comfort') +
  theme( plot.title = element_text( size = 18, face = 'bold', color = 'darkblue', hjust = .5 ),
         plot.subtitle = element_text( size = 14, face = 'bold', hjust = .5 ),
         axis.title = element_text( size = 12, face = 'bold' ),
         legend.position = 'bottom',
         legend.title = element_text( face = 'bold', size = 14 ),
         legend.text = element_text( size = 12 ),
         plot.caption = element_text( size = 11 )) +
  scale_color_manual( values = c(1,2) )
p


```


Setup data for continuation ratio ordinal mixed-effects logistic regression analyses.

```{r}
cr.vals.hm <- cr_setup( hm.use$depimpa.smb )
cr.data.hm <- hm.use[cr.vals.hm$subs, ]
cr.data.hm$depimpa.new <- cr.vals.hm$y
cr.data.hm$cohort <- cr.vals.hm$cohort

```




```{r}
# hm1.imp <- mixed_model( fixed = depimpa.new ~ year.smb 
#                 + offcampus*age20plus*dxany.smb
#                 + sex.smb
#                 + race.smb
#                 + intnat.smb
#                 + hetero.smb
#                 + fincurf.smb
#                 + dxany.smb
#                 + cohort
#                 ,
#                 random =~ offcampus | schoolf,
#                 data = cr.data.hm,
#                 family = binomial() )
#save( hm1.imp, file = 'hm1.imp.RData' )

load( 'hm1.imp.RData' )

```




```{r}
# hm2.imp <- mixed_model( fixed = depimpa.new ~ year.smb
#                 + offcampus*age20plus*dxany.smb
#                 + sex.smb
#                 + race.smb
#                 + intnat.smb
#                 + hetero.smb
#                 + fincurf.smb
#                 + dxany.smb
#                 + cohort
#                 ,
#                 random =~ 1 | schoolf,
#                 data = cr.data.hm,
#                 family = binomial() )
# save( hm2.imp, file = 'hm2.imp.RData' )

 load( 'hm2.imp.RData' )
# 
# hm2a.imp <- glmer( depimpa.smb ~ year.smb
#                 + offcampus*age20plus*dxany.smb
#                 + sex.smb
#                 + race.smb
#                 + intnat.smb
#                 + hetero.smb
#                 + fincurf.smb
#                 + dxany.smb
#                 + ( 1 | schoolf ),
#                 data = hm.use,
#                 nAGQ = 11,
#                 family = binomial('logit') )
# save( 'hm.2a.imp.Rdata' )
# load( 'hm2a.imp.RData' )
# hm2a.ci <- exp( confint( hm.2a.imp ) )


# hm.2a.imp <- clmm( depimpa.smb ~ year.smb 
#                 + offcampus*age20plus*dxany.smb
#                 + sex.smb
#                 + race.smb
#                 + intnat.smb
#                 + hetero.smb
#                 + fincurf.smb
#                 + dxany.smb 
#                 + ( 1 | schoolf ),
#                 data = hm.use )
# 
# 
# 
# hm2c.imp <- mixed_model( fixed = depimpa.new ~ year.smb 
#                 + offcampus*age20plus*dxany.smb
#                 + sex.smb
#                 + race.smb
#                 + intnat.smb
#                 + hetero.smb
#                 + fincurf.smb
#                 + dxany.smb
#                 + cohort*offcampus
#                 ,
#                 random =~ 1 | schoolf,
#                 data = cr.data.hm,
#                 family = binomial() )
# save( hm2c.imp, file = 'hm2.imp.RData' )

```


```{r}
anova( hm1.imp, hm2.imp )
```



```{r}
hm.use$depimpa3.smb <- hm.use$depimpa.smb 
hm.use$depimpa3.smb[ hm.use$depimpa.smb == 'extremely difficult' ] <- 'very difficult'
hm.use$depimpa3.smb <- ordered( hm.use$depimpa3.smb )

cr.vals.hm2 <- cr_setup( hm.use$depimpa3.smb )
cr.data.hm2 <- hm.use[cr.vals.hm2$subs, ]
cr.data.hm2$depimpa3.new <- cr.vals.hm2$y
cr.data.hm2$cohort <- cr.vals.hm2$cohort


# hm3.imp <- mixed_model( fixed = depimpa3.new ~ year.smb 
#                 + offcampus*age20plus*dxany.smb
#                 + sex.smb
#                 + race.smb
#                 + intnat.smb
#                 + hetero.smb
#                 + fincurf.smb
#                 + dxany.smb
#                 + cohort
#                 ,
#                 random =~ 1 | schoolf,
#                 data = cr.data.hm2,
#                 family = binomial() )
#save( hm3.imp, file = 'hm3.imp.RData' )
load( 'hm3.imp.RData' )

# hm3a.imp <- mixed_model( fixed = depimpa3.new ~ year.smb 
#                 + offcampus*age1819*dxany.smb
#                 + sex.smb
#                 + race.smb
#                 + intnat.smb
#                 + hetero.smb
#                 + fincurf.smb
#                 + dxany.smb
#                 + cohort
#                 ,
#                 random =~ 1 | schoolf,
#                 data = cr.data.hm2,
#                 family = binomial() )
# save( hm3a.imp, file = 'hm3a.imp.RData' )

load( 'hm3.imp.Rdata' )


# hm4.imp <- mixed_model( fixed = depimpa3.new ~ year.smb 
#                 + offcampus*age20plus*dxany.smb
#                 + sex.smb
#                 + race.smb
#                 + intnat.smb
#                 + hetero.smb
#                 + fincurf.smb
#                 + dxany.smb
#                 + cohort*offcampus
#                 ,
#                 random =~ 1 | schoolf,
#                 data = cr.data.hm2,
#                 family = binomial() )
# save( hm4.imp, file = 'hm4.imp.RData' )
load( 'hm4.imp.Rdata' )
```



